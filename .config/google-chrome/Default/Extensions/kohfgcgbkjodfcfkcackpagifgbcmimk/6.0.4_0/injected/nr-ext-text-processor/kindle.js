var doc=doc&&"kindle"===doc.type?doc:new function(){this.type="kindle";let e=this;e.getTexts=async function(n){if(e.alreadyParsed){if(e.alreadyParsed=!1,null!=e.parsingPromise){await e.parsingPromise;return e.parsingPromise=null,Promise.resolve(t)}return Promise.resolve(t)}try{await i();return e.alreadyParsed=!1,Promise.resolve(t)}catch(e){return Promise.reject(new Error("ERR_EBOOK"))}},e.isSameText=n,e.noSupportImmersive=!0,e.scrollToAdjacentPage=o,e.getTextsOfNextPage=function(){return o("next").then((async()=>{e.alreadyParsed=!0,e.parsingPromise=i()})).catch((e=>{}))},e.highlightLocation=function(t){if(n()){const n=Array.from(document.getElementsByClassName("kr-interaction-layer-fullpage"))[0],i=Array.from(document.getElementsByTagName("ion-header"))[0].getBoundingClientRect(),o=n.getBoundingClientRect(),r={};r.height=o.height-i.height,r.width=o.width,r.top=o.top+i.bottom,r.left=o.left;const l=e.sentences[t][1],s=l[0],a=l[1],c=l[2]-l[0],h=l[7]-l[1];let g=document.getElementById("nr-kindle-canvas");g||(g=document.createElement("canvas"),g.id="nr-kindle-canvas",g.style.position="fixed",g.style.zIndex="500",g.width=r.width,g.height=r.height,g.style.top=r.top+"px",g.style.left=r.left+"px",document.body.insertBefore(g,document.body.firstChild)),g.style.display="block";const d=g.getContext("2d");d.clearRect(0,0,g.width,g.height),d.fillStyle="rgba(213,229,254,0.5)",d.fillRect(s,a,c,h)}else a()},e.removeLocationHighlight=a,e.hideHighlightCanvas=function(){document.getElementById("nr-kindle-canvas")&&(document.getElementById("nr-kindle-canvas").style.display="none")},e.alreadyParsed=!1,e.parsingPromise=null,e.sentences=[];let t=[];function n(){let t=!0;const n=Array.from(document.querySelectorAll('[item-i-d="reader-footer-title"]'))[0].innerText;let i=null;try{i=parseInt(n.split("Location")[1].split(" of")[0]),i&&i!==e.locationNum&&(t=!1)}catch(e){}let o=null;try{o=parseInt(n.split("Page")[1].split(" of")[0]),o&&o!==e.pageNum&&(t=!1)}catch(e){}return t}function i(){const n=document.getElementById("nr-kindle-canvas");return n&&(n.style.display="none"),new Promise((e=>{e();let t=setInterval((()=>{const i=Array.from(document.getElementsByClassName("kg-loader"))[0];$(i).is(":visible")||(clearInterval(t),clearTimeout(n),e())}),100);const n=setTimeout((()=>{clearInterval(t),e()}),1e4)})).then((async()=>{const n=Array.from(document.getElementsByClassName("kr-interaction-layer-fullpage"))[0];await function(n){let i=!1,o=!1;return new Promise((e=>{"undefined"!=typeof readingBar?(i=readingBar.settings.isVisible,"undefined"!=typeof nrCC&&(o=nrCC.isVisible),$("body").children().hide(),$("#root").show(),setTimeout((()=>{e()}),100)):e()})).then((async()=>{const s=n.getBoundingClientRect(),a=Array.from(document.getElementsByTagName("ion-header"))[0].getBoundingClientRect(),c={};c.height=s.height-a.height,c.width=s.width,c.top=s.top+a.bottom,c.left=s.left;const h=window.devicePixelRatio;let g=await l(c,h);if("ERR_MAX_CAPTURE_VISIBLE_TAB_CALLS_PER_SECOND"===g&&(g=await l(c,h)),i?readingBar.setReadingBarVisibility(!0):readingBar.setReadingBarVisibility(!1),o?nrCC.setCCVisibility(!0):nrCC.setCCVisibility(!1),"ERR"===g)return Promise.reject(new Error("ERR_EBOOK"));const d=await function(e){return new Promise((t=>{chrome.runtime.sendMessage({fn:"ocrImage",image:e},(function(e){chrome.runtime.lastError&&t(null),t(e)}))})).catch((e=>{}))}(g);if(!d)throw new Error("ERR_EBOOK");let m=[];const u=d.analyzeResult.readResults;for(let e=0;e<u.length;e++)m=m.concat(u[e].lines);const f=function(e){const t=function(e){const t=Math.floor(e.length/2),n=[...e].sort(((e,t)=>e-t));return e.length%2!=0?n[t]:(n[t-1]+n[t])/2}(e.map((e=>e.height))),n=[];let i={lines:[e[0]],top:e[0].top,left:e[0].left,right:e[0].right};for(let o=1;o<e.length-1;o++){const r=e[o],l=i.lines[i.lines.length-1],s=r.top-l.bottom;s<=t&&s>=0?(i.lines.push(r),i.top=Math.min(i.top,r.top),i.right=Math.max(i.right,r.right),i.left=Math.min(i.left,r.left)):(n.push(i),i={lines:[r],top:r.top,left:r.left,right:r.right})}return i.lines.push(e[e.length-1]),n.push(i),function(e){if(e.length>=2)for(let t=e.length-1;t>=1;t--)1===e[t-1].lines.length&&1===e[t-1].lines[0].text.length&&e[t].lines[0].left-e[t-1].lines[0].right<=.002&&(e[t].lines[0].text=e[t-1].lines[0].text+e[t].lines[0].text,e[t].top=Math.min(e[t-1].top,e[t].top),e[t].right=Math.max(e[t-1].right,e[t].right),e[t].left=Math.min(e[t-1].left,e[t].left),e.splice(t-1,1))}(n),n}(function(e,t,n){const i=[];for(let o=0;o<e.length;o++){const r=e[o],l={text:r.text,top:r.boundingBox[1]/t,left:r.boundingBox[0]/n,bottom:r.boundingBox[5]/t,right:r.boundingBox[2]/n,boundingBox:r.boundingBox};l.width=l.right-l.left,l.height=l.bottom-l.top,i.push(l)}return i}(m,d.analyzeResult.readResults[0].height,d.analyzeResult.readResults[0].width));let p=[];const y=Date.now();for(let e=0;e<f.length;e++){const t=f[e].lines.map((e=>e.text));let n="";for(let e=0;e<t.length;e++)n+=t[e]+y+" ";p=p.concat(r(n))}let E=0;e.sentences=[];const R=(""+y).length;for(let t=0;t<p.length;t++){let n=p[t],i=m[E].boundingBox;for(;n.indexOf(y)>-1;){const o=n.replace(y,"");e.sentences[t]=[o,i],E++,n.indexOf(y)<n.length-R&&(i=m[E].boundingBox,i=[Math.min(i[0],e.sentences[t][1][0]),Math.min(i[1],e.sentences[t][1][1]),Math.max(i[2],e.sentences[t][1][2]),Math.min(i[3],e.sentences[t][1][3]),Math.max(i[4],e.sentences[t][1][4]),Math.max(i[5],e.sentences[t][1][5]),Math.min(i[6],e.sentences[t][1][6]),Math.max(i[7],e.sentences[t][1][7])],e.sentences[t]=[o,i]),n=o}e.sentences[t]=[n,i]}t=e.sentences.map((e=>e[0]))})).catch((e=>Promise.reject(new Error("ERR_EBOOK"))))}(n)})).catch((e=>Promise.reject(e)))}function o(e){return new Promise((t=>{"next"===e?(document.getElementById("kr-chevron-right").click(),t()):(document.getElementById("kr-chevron-left").click(),t())})).then((()=>{a()})).catch((e=>{}))}function r(e){const t=getNlpSentences(e);return processSentencesByLength(t)}function l(t,n=1){return new Promise(((i,o)=>{const r=Array.from(document.querySelectorAll('[item-i-d="reader-footer-title"]'))[0].innerText;e.footerText=r,e.locationNum=null;try{e.locationNum=parseInt(r.split("Location")[1].split(" of")[0])}catch(e){}e.pageNum=null;try{e.pageNum=parseInt(r.split("Page")[1].split(" of")[0])}catch(e){}chrome.runtime.sendMessage({fn:"captureRect",rect:t,devicePixelRatio:n},(async function(e){chrome.runtime.lastError&&i(null),"ERR_MAX_CAPTURE_VISIBLE_TAB_CALLS_PER_SECOND"===e?o(new Error("ERR_MAX_CAPTURE_VISIBLE_TAB_CALLS_PER_SECOND")):i(await s(t,e))}))})).catch((e=>Promise.resolve("ERR_MAX_CAPTURE_VISIBLE_TAB_CALLS_PER_SECOND")))}function s(e,t=null){return new Promise((n=>{if(t){const i=new Image;i.onload=function(){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const o=t.getContext("2d"),r=devicePixelRatio;o.drawImage(i,e.left*r,e.top*r,e.width*r,e.height*r,0,0,e.width,e.height);const l=t.toDataURL("image/png");chrome.runtime.sendMessage({fn:"setPreviousTabActive"},(()=>chrome.runtime.lastError)),n(l)},i.src=t}else n(null)})).catch((e=>{}))}function a(){let e=document.getElementById("nr-kindle-canvas");if(e){e.getContext("2d").clearRect(0,0,e.width,e.height)}}};