function NRTextProcessor(){let e=this;async function t(e,t,n){try{let o=0,a="nr-"+e+(e?"-":"")+"s"+t;"immersive"===e&&"undefined"!=typeof readingBar?await replaceNRTagsWithTextNodes("nr-word",!0,readingBar.immersiveTextContainer):await replaceNRTagsWithTextNodes("nr-word");let s=[];s="immersive"==e&&"undefined"!=typeof readingBar?Array.from(readingBar.readingBarDocument.document.getElementsByClassName(a)):Array.from(document.getElementsByClassName(a));let i=createDeepCopy(n);for(let e=0;e<s.length;e++){let t=s[e];t.normalize();let l=null;document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null,!1);let c=null;for(;c=l.nextNode();){let e=await r(c,a,i,o);if(!e||!e.node)break;let t=e.index;if(l.currentNode=e.node,o!=t&&(o=t,o>n.length-1))break}}}catch(e){}}async function r(e,t,r,n){try{if(n>r.length-1)return;if(!e.nodeValue||""===processHtmlText(e.nodeValue).trim())return{index:n,node:e};let o=0,a=0,s=e.nodeValue,i=s.length,l=r[n],c=n,d=!1;for(;o<s.length;){if(processTextForCharComparison(s[o])===processTextForCharComparison(l[0])&&(d||(a=o,d=!0),l=l.substring(1),0===l.length)){o++,c++;break}o++}if(!d)return{index:n,node:e};i=o,r[n]=l;let u=document.createElement("nr-word");$(u).addClass(t+"w"+n),0!==a&&(e=e.splitText(a),i-=a);e.splitText(i);return $(e).wrap(u),{index:c,node:e}}catch(e){}}function n(e,t,r,n,o){return new Promise((async s=>{let i="nr-"+e+(e?"-":"")+"s"+n;if(readingBar.settings.beHighlighted.includes("word")){let n=[];if("cc"===e&&"undefined"!=typeof readingBar){const e=readingBar.ccText;n=Array.from(e.getElementsByClassName(i))}else n="immersive"===e&&"undefined"!=typeof readingBar?Array.from(readingBar.readingBarDocument.getElementsByClassName(i)):Array.from(document.getElementsByClassName(i));for(let e=0;e<n.length;e++){let s=n[e],l=document.createTreeWalker(s,NodeFilter.SHOW_TEXT,null,!1),c=null;for(;c=l.nextNode();){let e=await a(c,o,i,t,r);if(!e.node)break;if(!(t=e.word))break;l.currentNode=e.node}if(!t)break}s(t)}else s(t)})).catch((e=>{}))}function o(e,t,r){let n="nr-"+e+(e?"-":"")+"s"+t+"w"+(r-1),o=[];if("cc"===e&&"undefined"!=typeof readingBar){const e=readingBar.ccText;o=Array.from(e.getElementsByClassName(n))}else o="immersive"===e&&"undefined"!=typeof readingBar?Array.from(readingBar.readingBarDocument.getElementsByClassName(n)):Array.from(document.getElementsByClassName(n));let a=getTextNodes(o[o.length-1]);return a[a.length-1]}function a(e,t=null,r,n,o){n=n.trim();try{if(t&&t.compareDocumentPosition(e)!==Node.DOCUMENT_POSITION_FOLLOWING)return{node:e,word:n};if(!e.nodeValue||""===processHtmlText(e.nodeValue).trim())return{node:e,word:n};let a=0,s=0,i=$(e).text(),l=i.length,c=!1;for(;a<i.length;){if(processTextForCharComparison(i[a])===processTextForCharComparison(n[0])&&(c||(s=a,c=!0),0===(n=n.substring(1)).length)){a++;break}a++}if(!c)return{node:e,word:n};l=a;let d=document.createElement("nr-word");$(d).addClass(r+"w"+o),0!==s&&(e=e.splitText(s),l-=s);e.splitText(l);return $(e).wrap(d),{node:e,word:n}}catch(e){}}e.processHtmlText=processHtmlText,e.processSentencesByLength=processSentencesByLength,e.getNlpSentences=getNlpSentences,e.textsToRead=[],e.getTextsFromPage=function(t="all",r){return doc.getTexts(t,r).then((t=>new Promise((r=>{let n=[];n=Array.from(document.querySelectorAll("nr-sentence")),n.forEach((e=>{nrDomController.bindClickToReadEvents(e)})),e.textsToRead=t,r()})))).then((()=>function(e){return new Promise((async t=>{if(readingBar.settings.isAutoSelectVoice){let r=getLang()||await utils.detectLanguage(e);await voices.autoSelectVoice(r),t()}else t()})).catch((e=>{}))}(e.textsToRead))).then((()=>{if("undefined"!=typeof readingBar&&!doc.noSupportImmersive&&e.textsToRead.length>0)return readingBar.setImmersiveTexts()})).then((()=>Promise.resolve(e.textsToRead))).catch((t=>"ERR_ALREADY_PARSED"===t?Promise.resolve(e.textsToRead):"ERR_EBOOK"===t?Promise.resolve(ERR_EBOOK):void 0))},e.getTextsOfNextPage=function(){doc.getTextsOfNextPage&&doc.getTextsOfNextPage()},e.setWordsForMainTextAndCC=function(e,r,n){let o=e.index,a=e.words;t("",o,a),t("immersive",o,a),t("cc",o,a)},e.setWordForMainTextAndCC=async function(e,t,r){try{let a=o("",e,r);const s=o("immersive",e,r);await replaceNRTagsWithTextNodes("nr-word",!1),await replaceNRTagsWithTextNodes("nr-word",!1,readingBar.immersiveTextContainer),await n("",t,r,e,a),await n("immersive",t,r,e,s),function(e,t,r){try{const n="nr-cc-s"+r+"w"+t;if(0===$(readingBar.ccText).find("nr-cc-word").length){let t=$(readingBar.ccText).html();t=t.replace(new RegExp("("+e+")","i"),'<nr-cc-word class="'+n+'">$1</nr-cc-word>'),$(readingBar.ccText).html(t)}else{let t=readingBar.ccText.lastChild;$(readingBar.ccText).find("nr-cc-word").contents().unwrap();let r=t.nodeValue;r=r.replace(new RegExp("("+e+")","i"),'<nr-cc-word class="'+n+'">$1</nr-cc-word>'),$(t).replaceWith(r)}}catch(e){}}(t,r,e);if(Array.from(document.getElementsByClassName("nr-s"+e)).map((e=>{e.normalize()})),"undefined"!=typeof readingBar){Array.from(readingBar.readingBarDocument.getElementsByClassName("nr-immersive-s"+e)).map((e=>{e.normalize()}))}}catch(e){}},e.isSameText=function(){return!doc.isSameText||doc.isSameText()},e.getCurrentIndex=function(){let e=0;doc.getCurrentIndex&&(e=doc.getCurrentIndex());return e},e.setWord=n,e.resetDocInnerTexts=function(){doc.docInnerText=""},e.asyncFunctions=["getTextsFromPage","getCurrentIndex","isSameText"],chrome.runtime.onMessage.addListener((function(t,r,n){if(e[t.fn]){if(e[t.fn](t,r,n),o=t.fn,e.asyncFunctions.includes(o))return!0}else"removeNRTags"===t.message&&removeNRTags();var o}))}var nrTextProcessor=nrTextProcessor||new NRTextProcessor,ignoreTags=ignoreTags||"select, textarea, button, label, audio, video, dialog, embed, menu, nav, noframes, noscript, object, script, style, svg, aside, footer, #footer, .no-read-aloud, #nr-webreader, #nr-ext-reading-bar, .nr-webreader-trigger-container, .nr-webreader-check, .nr-webreader-frame",paragraphSplitter=paragraphSplitter||/(?:\s*\r?\n\s*){2,}/;function getInnerText(e){let t=e.innerText;return t?t.trim():""}function removeExtraSpace(e){return e.replace(/\s{2,}/g," ").trim()}function isNotEmpty(e){return e}function fixParagraphs(e){let t=[],r="";for(let n=0;n<e.length;n++)e[n]?(r&&(/-$/.test(r)?r=r.substr(0,r.length-1):r+=" "),r+=e[n].replace(/-\r?\n/g,""),e[n].match(/[.!?:)"'\u2019\u201d]$/)&&(t.push(r),r="")):r&&(t.push(r),r="");return r&&t.push(r),t}function tryGetTexts(e,t){return function(e){return new Promise((function(t){setTimeout(t,e)}))}(500).then(e).then((function(r){return r&&!r.length&&t-500>0?tryGetTexts(e,t-500):r}))}function loadPageScript(e){$("head").length||$("<head>").prependTo("html"),$.ajax({dataType:"script",cache:!0,url:e})}function getLang(){var e=document.documentElement.lang||$("html").attr("xml:lang");return e&&(e=e.split(",",1)[0].replace(/_/g,"-")),"en"!=e&&"en-US"!=e||(e=null),e}function processSentencesByLength(e){let t=[];for(let r=0;r<e.length;r++){let n=splitIntoSentences(e[r]);n=mergeShort(n),t.push(...n)}return t}function processHtmlText(e){return e=removeDumbChars(e=removeExtraSpaces(e=replaceHTMLSpaces(e=removeLineBreaks(e))))}function removeDumbChars(e){return e&&e.replace(/\u200c/g,"")}function removeLineBreaks(e){return e.replace(/(\r\n|\n|\r)/gm," ")}function replaceHTMLSpaces(e){return e=(e=e.replace(/&nbsp;/gi," ")).replace(/[\u200c|\u200b|\u200d|\ufeff]/gi," ")}function removeExtraSpaces(e){return e.replace(/\s+/g," ")}function getNlpSentences(e){let t=nlp(e).sentences().data();t=t.map((e=>e.text.trim())),e=Array.from(e);const r=[];let n=0;for(let o=0;o<t.length;o++){let a=Array.from(t[o]),s=0;for(;!e[n].trim();)n++;for(;s<a.length;)a[s]===e[n]?(n++,s++):a.splice(s,1);r.push(a.join(""))}return r}function processTextForCharComparison(e){let t=processHtmlText(e);return t=t.replace(/[\u2018|\u2019|\u2039|\u203A]/g,"'"),t=t.replace(/[\u2014|\u2015]/g,"-"),t.toLowerCase()}function splitIntoSentences(e,t=200){let r=[];for(;e.length>0;){let n=getIndexOfSplitPoint(e,t),o=e.substring(0,n+1);r.push(o),e=e.substring(n+1)}return r}function mergeShort(e){let t="",r=[];for(let n=0;n!=e.length;n++){t+=e[n];let o=!0;n+1<e.length&&((t+e[n+1]).length>250&&(o=!1),t.length<50&&(o=!0)),n!=e.length-1&&o||(r.push(t),t="")}return r}function getIndexOfSplitPoint(e,t){let r=["?","!","¿","¡","。","～","……","！","？"],n=[",",";",":","，","；","："],o=e.substring(0,t);if(e.length<=t)return e.length-1;{let a=Number.MAX_VALUE;for(let e=0;e<r.length;e++){let t=o.indexOf(r[e]);t<=a&&t>=0&&(a=t)}if(a===Number.MAX_VALUE&&(a=-1),a<=0){for(let e=0;e<n.length;e++)a=Math.max(o.lastIndexOf(n[e]),a);return a<=0&&(a=o.lastIndexOf(" "),a<=0&&(a=o.lastIndexOf("〿"))),a<=0?t-1:a}return e[a+1]&&'"'===e[a+1]?a+1:a}}async function removeNRTags(e=null,t=null,r=null){let n=!0;e&&void 0!==e.toNormalize&&(n=e.toNormalize);try{const e=Array.from(document.getElementsByTagName("nr-overlay"));for(let t=0;t<e.length;t++)e[t].remove();await replaceNRTagsWithTextNodes("nr-word",n),await replaceNRTagsWithTextNodes("nr-sentence",n)}catch(e){}}function replaceNRTagsWithTextNodes(e,t=!0,r=null){let n=[],o=new Set;return new Promise((async a=>{let s=[];s=r?$(r).find(e).get():$(document.body).find(e).get(),s.map((e=>{t&&o.add(e.parentNode),n.push(unwrapNode(e))})),a(n)})).then((e=>Promise.all(e))).then((()=>new Promise((e=>{if(t){o=Array.from(o);for(let e=0;e<o.length;e++)o[e].normalize()}e()})))).catch((e=>{}))}function unwrapNode(e){$.when($(e).contents().unwrap()).then((()=>Promise.resolve()))}function getTextNodes(e){let t=[];if(e&&e instanceof Node){let r=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1),n=null;for(;n=r.nextNode();)t.push(n)}return t}function getSelectedNodes(){if(window.getSelection){let e=window.getSelection();if(!e.isCollapsed){let t=getRangeSelectedNodes(e.getRangeAt(0)),r=[],n=[];return r=t.filter((e=>"p"===e.nodeName.toLowerCase()||"div"===e.nodeName.toLowerCase())),r=[...new Set(r)],n=t.filter((e=>3==e.nodeType&&""!==$(e).text().trim()&&"style"!==e.parentNode.nodeName.toLowerCase())),{pNodes:r,textNodes:n,allNodes:t}}}return{pNodes:[],textNodes:[],allNodes:[]}}function getRangeSelectedNodes(e){let t=e.startContainer,r=e.endContainer;if(t==r)return[t];let n=[];for(;t&&t!=r;){let e=$(t).closest("p")[0];e&&n.push(e),n.push(t=nextNode(t))}for(t=e.startContainer;t&&t!=e.commonAncestorContainer;)n.unshift(t),t=t.parentNode;return n}function nextNode(e){if(e.hasChildNodes())return e.firstChild;for(;e&&!e.nextSibling;)e=e.parentNode;return e?e.nextSibling:null}function createDeepCopy(e){let t=[];for(let r=0;r<e.length;r++)t.push(e[r]);return t}