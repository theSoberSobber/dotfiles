function NRDomController(){let e=this;function n(n){r(n);let i=null;i=readingBar.isImmersive?readingBar.readingBarDocument.getElementsByClassName("nr-immersive-s"+(n-1))[0]:document.getElementsByClassName("nr-s"+(n-1))[0];let t=null;if(t=readingBar.isImmersive?readingBar.readingBarDocument.getElementsByClassName("nr-immersive-s"+n)[0]:document.getElementsByClassName("nr-s"+n)[0],"kindle"!==doc.type){const r=g(i)||g(t);e.isAutoScroll&&r&&("undefined"!=typeof readingBar&&readingBar.hideRelocateButton(),s(n)),r||"undefined"==typeof readingBar||readingBar.showRelocateButton()}}function r(n){if("kindle"===doc.type)doc.highlightLocation(n);else{if(readingBar.isImmersive){const e=readingBar.readingBarDocument.getElementsByTagName("nr-sentence");for(let n=0;n<e.length;n++)e[n].classList.add("nr-not-read")}if(!e.beHighlighted.includes("sentence"))return;e.removeHighlight(),"undefined"!=typeof readingBar&&(e.currHighlightedImmersiveSentence=readingBar.readingBarDocument.getElementsByClassName("nr-immersive-s"+n),t(e.currHighlightedImmersiveSentence,"add","sentence")),e.currHighlightedSentence=document.getElementsByClassName("nr-s"+n),t(e.currHighlightedSentence,"add","sentence")}}function i(e=["sentence","word"]){if("undefined"!=typeof doc&&"kindle"===doc.type)1===e.length&&"word"===e[0]||doc.removeLocationHighlight();else{if(e.includes("sentence")){if(t(Array.from(document.getElementsByClassName("nr-highlighted-sentence")),"remove","sentence"),"undefined"!=typeof readingBar){t(Array.from(readingBar.readingBarDocument.getElementsByClassName("nr-highlighted-sentence")),"remove","sentence")}}if(e.includes("word")){if(t(Array.from(document.getElementsByClassName("nr-highlighted-word")),"remove","word"),"undefined"!=typeof readingBar){t(Array.from(readingBar.readingBarDocument.getElementsByClassName("nr-highlighted-word")),"remove","word")}}}}function t(n,r,i){if(n)for(let t=0;t<n.length;t++)n[t]&&("add"===r&&e.beHighlighted.includes(i)?(n[t].classList.add("nr-"+i+"-highlight-"+e.highlightColour),n[t].classList.add("nr-highlighted-"+i)):(n[t].classList.remove("nr-"+i+"-highlight-"+e.highlightColour),n[t].classList.remove("nr-highlighted-"+i)))}function a(n,r="pause"){e.removeHighlight(),e.highlightColour=n,"reading"===r&&(e.beHighlighted.includes("sentence")&&t(e.currHighlightedSentence,"add","sentence"),e.beHighlighted.includes("word")&&t(e.currHighlightedWord,"add","word"))}function d(n){e.beHighlighted=n,e.beHighlighted.includes("sentence")?"reading"===reader.state&&r(reader.currReadIndex):i(["sentence"]),e.beHighlighted.includes("word")||i(["word"])}function o(n){e.isAutoScroll=n,"reading"===reader.state&&e.isAutoScroll&&s(reader.currReadIndex)}function s(e){try{let n=null;n="undefined"!=typeof readingBar&&readingBar.isImmersive?readingBar.readingBarDocument.getElementsByClassName("nr-immersive-s"+e)[0]:document.getElementsByClassName("nr-s"+e)[0],n&&("googleDoc"!==doc.type||"undefined"==typeof readingBar||readingBar.isImmersive?n.scrollIntoView({behavior:"smooth",block:"center"}):n.scrollIntoView({behavior:"smooth",block:"nearest",inline:"start"}),readingBar.hideRelocateButton())}catch(e){}}function g(e){if(e){const n=e.getBoundingClientRect();return"undefined"!=typeof readingBar&&readingBar.isImmersive,n.top>=0&&n.left>=0&&n.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&n.right<=(window.innerWidth||document.documentElement.clientWidth)}return!1}function l(){"undefined"!=typeof readingBar&&(a(readingBar.settings.highlightColour,reader.state),d(readingBar.settings.beHighlighted),o(readingBar.settings.isAutoScroll)),"pause"===reader.state||"init"===reader.state?i():"reading"===reader.state&&n(reader.currReadIndex)}function c(e,n){e.forEach((e=>{e.classList.add(n)}))}function m(e,n){e.forEach((e=>{e.classList.remove(n)}))}e.highlightColour="light",e.beHighlighted=[],e.isAutoScroll=!0,e.readerOnPlay=function(){n(reader.currReadIndex)},e.readerOnPause=function(){if(i(),readingBar.isImmersive&&"undefined"!=typeof nrExtImmersiveReader){const e=nrExtImmersiveReader.immersiveDocument.getElementsByTagName("nr-sentence");for(let n=0;n<e.length;n++)e[n].classList.remove("nr-not-read")}},e.readerOnStop=function(){i()},e.setCurrRead=n,e.currHighlightedSentence=null,e.currHighlightedCCSentence=null,e.currHighlightedImmersiveSentence=null,e.currHighlightedWord=null,e.currHighlightedImmersiveWord=null,e.highlightSentence=r,e.highlightWord=function(n,r){if(!e.beHighlighted.includes("word"))return;i(["word"]);let a="nr-s"+n+"w"+r;if(e.currHighlightedWord=document.getElementsByClassName(a),"undefined"!=typeof readingBar){let i=readingBar.ccText,a="nr-cc-s"+n+"w"+r;e.currHighlightedCCWord=i.getElementsByClassName(a),t(e.currHighlightedCCWord,"add","word")}t(e.currHighlightedWord,"add","word");const d="nr-immersive-s"+n+"w"+r;"undefined"!=typeof readingBar&&(e.currHighlightedImmersiveWord=readingBar.readingBarDocument.getElementsByClassName(d),t(e.currHighlightedImmersiveWord,"add","word"))},e.scrollTo=s,e.highlightLocation=function(e){doc.highlightLocation&&doc.highlightLocation(e)},e.removeHighlight=i,e.setUI=l,e.scrollToAdjacentPage=function(e="next"){return new Promise((function(n){return doc.scrollToAdjacentPage?doc.alreadyParsed?n(null):doc.scrollToAdjacentPage(e).then((e=>n(e))):n("ERR")})).catch((e=>Promise.resolve("ERR")))},e.scrollToPage=function(e,n,r){return new Promise((function(n){if(doc.scrollToPage)return doc.scrollToPage(e.pageIndex).then((e=>{r(e),n(e)}));r("ERR")})).catch((e=>{r("ERR")}))},e.bindClickToReadEvents=function(n,r="default"){try{let r=parseInt(n.id.split("nr-s")[1]);n.onmouseover=()=>{if(m(Array.from(document.getElementsByClassName("nr-onhover")),"nr-onhover"),readingBar.settings.isVisible&&e.activeTabId===e.beingReadTabId&&readingBar.settings.isClickToRead){if(("pause"===reader.state||"init"===reader.state)&&doc&&"googleDoc"===doc.type)return;c(Array.from(document.getElementsByClassName("nr-s"+r)),"nr-onhover")}},n.onmouseout=()=>{m(Array.from(document.getElementsByClassName("nr-s"+r)),"nr-onhover")},n.onclick=debounce((()=>{if(readingBar.settings.isVisible&&e.activeTabId===e.beingReadTabId&&readingBar.settings.isClickToRead){if(("pause"===reader.state||"init"===reader.state)&&doc&&"googleDoc"===doc.type)return;reader.readIndex(r)}}))}catch(e){}},e.bindClickToReadEventsForImmersiveReader=function(n){let r=parseInt(n.id.split("nr-immersive-s")[1]);n.onmouseover=()=>{if(m(Array.from(readingBar.readingBarDocument.getElementsByClassName("nr-onhover")),"nr-onhover"),e.activeTabId===e.beingReadTabId){c(Array.from(readingBar.readingBarDocument.getElementsByClassName("nr-immersive-s"+r)),"nr-onhover")}},n.onmouseout=()=>{m(Array.from(readingBar.readingBarDocument.getElementsByClassName("nr-immersive-s"+r)),"nr-onhover")},n.onclick=debounce((()=>{e.activeTabId===e.beingReadTabId&&reader.readIndex(r)}))},e.asyncFunctions=["scrollToPage"],e.beingReadTabId=null,e.activeTabId=null,chrome.runtime.onMessage.addListener((function(n,r,t){if(e[n.fn]){if(e[n.fn](n,r,t),s=n.fn,e.asyncFunctions.includes(s))return!0}else"readerOnStop"===n.message?(reader.state="init",i()):"tabOnActivated"===n.message?(e.beingReadTabId=n.beingReadTabId,e.activeTabId=n.activeTabId,n.beingReadTabId===n.activeTabId&&n.activeTabId===n.tabId?l():i()):"highlightColourOnChange"===n.message?a(n.highlightColour,n.readerState):"beHighlightedOnChange"===n.message?d(n.beHighlighted):"isAutoScrollOnChange"===n.message?o(n.isAutoScroll):"browserActionOnClicked"===n.message&&(e.beingReadTabId=n.beingReadTabId,e.activeTabId=n.activeTabId);var s})),l()}var nrDomController=nrDomController||new NRDomController;