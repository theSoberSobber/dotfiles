function WindowSpeechEngine(){let e=this;function t(t,n,o){if(t&&""!==t.trim()&&voices.voices.free&&(!voices.free||0!==Object.keys(voices.voices.free).length))return r().then((()=>new Promise((r=>{e.utterThis=new SpeechSynthesisUtterance,e.utterThis.text=t;let a="";reader.previewVoiceKey?(a=reader.previewVoiceKey,reader.previewVoiceKey=""):a="prem"===readingBar.settings.voiceType?readingBar.settings.premVoice:readingBar.settings.freeVoice,e.utterThis.voice=voices.voices.free[a].voice,e.utterThis.volume=parseFloat(readingBar.settings.volume),e.utterThis.rate=utils.calculateRate(readingBar.settings.speed,voices.voices.free[a]),e.onEvent=o,function(t,r){e.utterThis.onend=()=>{e.resumeIntervalRef&&clearInterval(e.resumeIntervalRef),e.onEvent&&e.onEvent({type:"end"})},e.utterThis.onerror=()=>{e.resumeIntervalRef&&clearInterval(e.resumeIntervalRef)},e.utterThis.onstart=()=>{e.onEvent&&e.onEvent({type:"start"})};let n=0;e.utterThis.onboundary=o=>{if("word"==o.name&&(void 0!==o.charLength||void 0!==o.length)){let a=r.substr(o.charIndex,o.charLength||o.length);e.onEvent&&e.onEvent({type:"word",word:a,wordIndex:n,index:t}),n++}}}(n,t),r(voices.voices.free[a])})))).then((t=>{e.synth.speak(e.utterThis),"google"===t.source&&(e.resumeIntervalRef=setInterval((()=>{e.synth.speaking?(e.synth.pause(),e.synth.resume()):clearInterval(e.resumeIntervalRef)}),5e3))})).catch((e=>{}));o({type:"end"})}function r(){return new Promise((t=>{e.resumeIntervalRef&&(clearInterval(e.resumeIntervalRef),e.resumeIntervalRef=null),e.utterThis&&(e.utterThis.onend=null,e.utterThis.onboundary=null,e.utterThis.onerror=null,e.utterThis=null),e.synth.cancel(),t()}))}e.type="free",e.synth=window.speechSynthesis,e.utterThis=null,e.playTimeoutRef=null,e.isStoppedWhenProcessingPlay=!1,e.isProcessingPlay=!1,e.play=t,e.pause=function(t=!0){e.stop(t)},e.stop=function(t=!0){e.onEvent&&t&&e.onEvent({type:"pause"});return e.synth.paused?Promise.resolve().then((()=>new Promise((t=>{e.synth.resume(),t()})))).then((()=>r())).catch((function(e){})):r()},e.resume=function(e,r){t(e,r,!1)},e.onEvent=null,e.resumeIntervalRef=null}function ChromeTtsEngine(){let e=this;e.init=function(){},e.type="free",e.play=function(n,o,a){if(!n||""===n.trim()||!voices.voices.free||voices.voices.free&&0===Object.keys(voices.voices.free).length)return void a({type:"end"});return r().then((function(r){e.onEvent=a,t=0;let i="";reader.previewVoiceKey?(i=reader.previewVoiceKey,reader.previewVoiceKey=""):i="prem"===readingBar.settings.voiceType?readingBar.settings.premVoice:readingBar.settings.freeVoice;let s=voices.voices.free[i].voice.name||voices.voices.free[i].voice.voiceName,l=utils.calculateRate(readingBar.settings.speed,voices.voices.free[i]),c=parseFloat(readingBar.settings.volume);setTimeout((()=>{browser.tts.speak(n,{voiceName:s,rate:l,volume:c,requiredEventTypes:["start","end","word"],desiredEventTypes:["start","end","error","interrupted","word"],onEvent:r=>{!function(r,n,o){if("start"==r.type)e.onEvent&&e.onEvent({type:"start"});else if("end"==r.type)e.resumeIntervalRef&&clearInterval(e.resumeIntervalRef),e.onEvent&&e.onEvent({type:"end"});else if("error"==r.type)e.resumeIntervalRef&&clearInterval(e.resumeIntervalRef);else if("word"==r.type&&(void 0!==r.charLength||void 0!==r.length)){let a=n.substr(r.charIndex,r.charLength||r.length);e.onEvent&&(e.onEvent&&e.onEvent({type:"word",word:a,wordIndex:t,index:o}),t++)}}(r,n,o)}}),"google"===voices.voices.free[i].source&&(e.resumeIntervalRef=setInterval((()=>{browser.tts.isSpeaking((function(t){t?(browser.tts.pause(),browser.tts.resume()):clearInterval(e.resumeIntervalRef)}))}),5e3))}),0)})).catch((e=>{}))},e.stop=function(t=!0){e.onEvent&&t&&e.onEvent({type:"pause"});browser.tts.stop()},e.pause=function(t=!0){e.stop(t)},e.onEvent=null,e.stopIfAlreadySpeaking=r,e.resumeIntervalRef=null;let t=0;function r(){return new Promise((function(t){e.resumeIntervalRef&&(clearInterval(e.resumeIntervalRef),e.resumeIntervalRef=null),browser.tts.isSpeaking((function(e){e&&browser.tts.stop(),t({isSpeaking:e})}))}))}}const freeTts=new WindowSpeechEngine;function OnlineTtsEngine(){class e{constructor(e,t,r,n){}}let t=this;function r(){return new Promise((e=>{t.playTimeoutRef&&clearTimeout(t.playTimeoutRef),t.wordMarkTimer&&clearInterval(t.wordMarkTimer),t.onEvent=null,t.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerClearPlay"},(()=>{e()})):(t.playPromise&&t.playPromise.then((()=>{t.audioPlayer.pause()})).catch((e=>{})),e())})).catch((e=>{}))}async function n(e,r,a){try{if(!e||!e||""===e.trim())return void(t.onEvent&&t.onEvent({type:"end"}));{let i=null!==r?r+"":readingBar.settings.premVoice+"_"+readingBar.settings.speed,c=null!==r?t.preloads[i]:t.previews[i];if(!c)return t.onEvent&&t.onEvent({type:"loading"}),l(e).then((n=>{t.preloads[i]={text:e,blob:n,index:r},o(t.preloads[i],a)})).catch((function(e){}));if(a!==t.playId)throw new Error("invalid playid");try{c.blob.isPending()&&t.onEvent&&t.onEvent({type:"loading"})}catch(e){}(await c.blob).text===e?o(c,a):(s(r),n(e,r,a))}}catch(e){}}async function o(e,r){try{if(r!==t.playId||!e)throw new Error("invalid playId");let o=await e.blob;o.err&&""!==o.err?(n=o.err,t.errCount++,t.errCount>=3||!u(n)?(t.hasError=!0,t.setNumPreloads(2,0),t.onEvent&&t.onEvent({type:"error",err:n,isTempError:u(n)})):(function(e){return 1002===e||1e3===e}(n)&&t.errCount>0&&t.errCount--,t.onEvent&&t.onEvent({type:"end"}))):(t.hasError&&(t.hasError=!1,t.hasInvalidLicenseError=!1,t.invalidLicenseErrorCount=0,t.isStoppedWhenProcessingPlay=!1,t.setNumPreloads(2,4)),async function(e,r){try{let n=null;return t.errCount=0,Promise.resolve().then((async()=>(n=await e.blob,Promise.resolve()))).then((()=>new Promise((e=>{t.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerSetSrc",tabId:t.playerTabId,src:n.url,text:n.text},(()=>{e()})):(t.audioPlayer.src=n.url,e())})))).then((()=>new Promise((e=>{t.currentVoice&&"aca"===t.currentVoice.source?t.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerSetVolume",tabId:t.playerTabId,volume:parseFloat(.5*readingBar.settings.volume)}):t.audioPlayer.volume=parseFloat(.5*readingBar.settings.volume):t.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerSetVolume",tabId:t.playerTabId,volume:parseFloat(readingBar.settings.volume)}):t.audioPlayer.volume=parseFloat(readingBar.settings.volume),e()})))).then((()=>new Promise((e=>{t.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerLoad",tabId:t.playerTabId},(()=>{e()})):(t.audioPlayer.load(),e())})))).then((()=>{if(function(){if(t.hasMediaViolation)return chrome.runtime.sendMessage({fn:"playerAddEventListenerToPlayer",tabId:t.playerTabId});t.audioPlayer.onended=()=>{t.onEvent&&t.onEvent({type:"end"})},t.audioPlayer.onplay=()=>{t.onEvent&&t.onEvent({type:"start"})},t.audioPlayer.onerror=()=>{t.onEvent&&t.onEvent({type:"error",err:t.audioPlayer.error.message})}}(),t.isStoppedWhenProcessingPlay)a();else try{if(r!==t.playId||!e)throw new Error("invalid playid");"undefined"!=typeof readingBar&&(t.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerSetPlaybackRate",tabId:t.playerTabId,rate:utils.calculateRate(readingBar.settings.speed)}):t.audioPlayer.playbackRate=utils.calculateRate(readingBar.settings.speed)),t.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerPlay",tabId:t.playerTabId}):t.playPromise=t.audioPlayer.play(),o=n.text,i=n.marks,t.hasMediaViolation?(t.textForMediaViolation=o,t.marksForMediaViolation=i):t.audioPlayer.oncanplay=()=>{try{t.wordMarkTimer&&clearInterval(t.wordMarkTimer);let e=0,r=performance.now(),n=(ttsText.getTextChunks(o),0);if(i&&0===i.length){let e=o.split(" "),a=[],i=0;for(let t=0;t<e.length;t++)e[t]?(a.push(i),i=i+e[t].length+1):i++;let s=0,l=1e3*t.audioPlayer.duration/utils.calculateRate(readingBar.settings.speed),c=l/o.length*.95;t.wordMarkTimer=setInterval((()=>{let i=performance.now();if(n=i-r,n>=l||l<=0||isNaN(t.audioPlayer.duration))return void clearInterval(t.wordMarkTimer);let u=Math.floor(n/c);u>o.length?clearInterval(t.wordMarkTimer):u>=a[s]&&t.onEvent&&t.onEvent({type:"word",word:e[s],wordIndex:s++})}),50)}else{const o=[];for(let e=0;e<i.length;e++)o.push(i[e].time/utils.calculateRate(readingBar.settings.speed));t.wordMarkTimer=setInterval((()=>{let a=performance.now();n=a-r,n>o[e]&&t.onEvent&&(t.onEvent({type:"word",word:i[e].word,wordIndex:e++}),e>=i.length&&clearInterval(t.wordMarkTimer))}),50)}}catch(e){}}}catch(e){}var o,i}))}catch(e){}t.isProcessingPlay=!1,t.isStoppedWhenProcessingPlay=!1}(e,r))}catch(n){}var n}function a(e){return t.onEvent&&e&&t.onEvent({type:"pause"}),t.isProcessingPlay&&(t.isStoppedWhenProcessingPlay=!0),r()}async function i(e,r){try{if(r!==t.playId)throw new Error("inavlid playId");let n=e+"";if(t.preloads[n])return;{let r=ttsText.textsForTts[e].processed;if(!r||""===r.trim())return;t.preloads[n]={text:r,blob:d(l(r)),index:e}}}catch(e){}}function s(e){null!==e&&delete t.preloads[e+""]}function l(t){return new Promise((async(r,n)=>{let o=3,a=new e("","",[],"");for(;o>0;){const e=await c(t);e.decrementAttemptCount?o--:(o=0,a=e)}r(a)})).catch((e=>{}))}function c(e){return new Promise((r=>{const n=function(e,r){let n="";if(reader.previewVoiceKey?(n=voices.voices[readingBar.settings.voiceType][reader.previewVoiceKey],reader.previewVoiceKey=""):n=voices.voices[readingBar.settings.voiceType][readingBar.settings[readingBar.settings.voiceType+"Voice"]],t.ttsEndpoint=t.premTtsEndpoint,"plus"===n.type&&(t.ttsEndpoint=t.plusTtsEndpoint),t.currentVoice=n,!n.id||!n.source)throw new Error("error");let o="",a="";return a=null!==n?"&r="+n.id+"&s=0&v="+n.source:"&r=21&s=0&v=aca",r&&r.email?(o+="?e="+r.email,void 0!==r.license&&(o+="&l="+r.license),r.ownerEmail&&(o+="&o="+r.ownerEmail),o+=a):o="?l=0"+a,o+="&vn="+chrome.runtime.getManifest().version+"&sm="+t.isSpeechMark,t.ttsEndpoint+o}(t.ttsEndpoint,readingBar.settings.userInfo);chrome.runtime.sendMessage({fn:"sendTtsRequest",queryEndpoint:n,text:e},(async function(e){const n=await function(e){if(e.url){const t=atob(e.url.split(",")[1]),r=[];for(let e=0;e<t.length;e++)r.push(t.charCodeAt(e));e.url=window.URL.createObjectURL(new Blob([new Uint8Array(r)],{type:"audio/mpeg"}))}return Promise.resolve(e)}(e);return""!==n.err?(function(e){if(1002==e||1005==e||1001==e||1003==e||1004==e||1006==e||"ERR_LICENSE_INVALID"==e||"Limit Exceeded"==e||"ERR_INVALID_REQUEST"==e||"ERR_EMPTY_TEXT"==e)return!0}(n.err)||("Too Many Requests"===n.err&&(t.hasTooManyRequestsError=!0),n.decrementAttemptCount=!0),r(n)):r(n)}))})).catch((e=>{}))}function u(e){return 1001!=e&&1003!=e&&1004!=e&&1005!=e&&1006!=e&&"ERR_LICENSE_INVALID"!=e&&"Limit Exceeded"!=e&&"ERR_EMPTY_TEXT"!=e}function d(e){try{if(e.isResolved)return e;let t=!0,r=!1,n=!1,o=e.then((function(e){return n=!0,t=!1,e}),(function(e){throw r=!0,t=!1,e}));return o.isFulfilled=function(){return n},o.isPending=function(){return t},o.isRejected=function(){return r},o}catch(t){return e}}t.type="online",t.ttsEndpoint,t.premTtsEndpoint="https://avf3h4i1vc.execute-api.us-east-1.amazonaws.com/prod-cpm/tts",t.plusTtsEndpoint="https://6rbmmgxig8.execute-api.us-east-1.amazonaws.com/prod-cps/tts",t.audioPlayer=null,t.errCount=0,t.playId=void 0,t.numPreloads={prev:2,next:4},t.preloads={},t.previews={},t.hasError=!1,t.hasTooManyRequestsError=!1,t.onEvent=null,t.wordMarkTimer=null,t.play=async function(e,o,a){t.previousText=e||null;t.playId=Date.now();let l=t.playId;return t.isStoppedWhenProcessingPlay?(t.isProcessingPlay=!1,t.isStoppedWhenProcessingPlay=!1,Promise.resolve()):(await r(),Promise.resolve().then((()=>(t.onEvent=a,n(e,o,l)))).then((()=>{if(null!==o&&l===t.playId)return async function(e,r){let n={};n[e+""]=!0;for(let o=1;o<t.numPreloads.next+1&&!t.isStoppedWhenProcessingPlay;o++)try{let t=await ttsText.getIndexOfNNextSentence(o,e);if(-1===t)break;n[t+""]=!0,i(t,r)}catch(e){continue}for(let r=1;r<t.numPreloads.prev+1&&!t.isStoppedWhenProcessingPlay;r++)try{let t=await ttsText.getIndexOfNPrevSentence(r,e);if(-1===t)break;n[t+""]=!0}catch(e){continue}!function(e){for(let r in t.preloads){let n=t.preloads[r];e[r]||s(n.index)}}(n)}(o,l)})).catch((e=>{})))},t.pause=function(e=!0){t.stop(e)},t.stop=a,t.clearPreloads=function(){t.preloads={}},t.clearBlobsWithError=async function(){for(let e in t.preloads){let r=t.preloads[e],n=await r.blob;"ERR_CONVERT_LIMIT"!==n.err&&1005!=n.err&&1006!==n.err&&"ERR_LICENSE_INVALID"!==n.err||s(r.index)}},t.setNumPreloads=function(e,r){t.numPreloads={prev:e,next:r}},t.isProcessingPlay=!1,t.isStoppedWhenProcessingPlay=!1,t.playPromise=null,t.hasInvalidLicenseError=!1,t.invalidLicenseErrorCount=0,t.currentVoice=null,t.isSpeechMark=!0,t.hasMediaViolation=!1,t.playerTabId=null,t.playerOnended=function(e,r,n){t.onEvent&&t.onEvent({type:"end"})},t.playerOnplay=function(e,r,n){t.onEvent&&t.onEvent({type:"start"})},t.playerOnerror=function(e,r,n){t.onEvent&&t.onEvent({type:"error",err:e.err})},t.playerOncanplay=function(){let e=t.textForMediaViolation,r=t.marksForMediaViolation;try{t.wordMarkTimer&&clearInterval(t.wordMarkTimer);let n=0,o=performance.now(),a=(ttsText.getTextChunks(e),0);if(r&&0===r.length){let r=e.split(" "),n=[],i=0;for(let e=0;e<r.length;e++)r[e]?(n.push(i),i=i+r[e].length+1):i++;let s=0,l=1e3*t.audioPlayer.duration/utils.calculateRate(readingBar.settings.speed),c=l/e.length*.95;t.wordMarkTimer=setInterval((()=>{let i=performance.now();if(a=i-o,a>=l||l<=0||isNaN(t.audioPlayer.duration))return void clearInterval(t.wordMarkTimer);let u=Math.floor(a/c);u>e.length?clearInterval(t.wordMarkTimer):u>=n[s]&&t.onEvent&&t.onEvent({type:"word",word:r[s],wordIndex:s++})}),50)}else{const e=[];for(let t=0;t<r.length;t++)e.push(r[t].time/utils.calculateRate(readingBar.settings.speed));t.wordMarkTimer=setInterval((()=>{let i=performance.now();a=i-o,a>e[n]&&t.onEvent&&(t.onEvent({type:"word",word:r[n].word,wordIndex:n++}),n>=r.length&&clearInterval(t.wordMarkTimer))}),50)}}catch(e){}},t.textForMediaViolation=null,t.marksForMediaViolation=null,t.previousText=null,t.asyncFunctions=[],t.audioPlayer=document.createElement("AUDIO"),browser.runtime.onMessage.addListener((function(e,r,n){if(t[e.fn]&&(t[e.fn](e,r,n),o=e.fn,t.asyncFunctions.includes(o)))return!0;var o}))}var onlineTts=onlineTts||new OnlineTtsEngine;