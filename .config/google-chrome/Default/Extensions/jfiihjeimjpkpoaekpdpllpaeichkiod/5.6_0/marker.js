document.getElementById("pageMarker_canvas")?exit():chrome.storage.sync.get({penColor:"#FF0000",penThickness:5,highlightThickness:22,eraseThickness:30,textSize:20},function(g){init(g)});function exit(){document.getElementById("pageMarker_canvas").remove();document.getElementById("pageMarker_draggable").remove()}
function convertHex(g,G=.3){var d=g.replace("#","");3===d.length&&(d=d[0]+d[0]+d[1]+d[1]+d[2]+d[2]);g=parseInt(d.substring(0,2),16);var H=parseInt(d.substring(2,4),16);d=parseInt(d.substring(4,6),16);return"rgba("+g+","+H+","+d+","+G+")"}
function init(g){function G(a,c){a.style.background=""}function d(a){b.discardActiveObject().renderAll();b.wrapperEl.style.cursor="crosshair";b.wrapperEl.style.pointerEvents="auto";b.selection=!0;b.isDrawingMode=!0;I=p=z=J=K=n=!1;R.forEach(G);a.style.background="rgba(0,0,0,0.2)"}function H(){var a=document.getElementById("pageMarker_draggable");(new Promise(function(c,e){a.style.display="none";setTimeout(function(){"none"==a.style.display?c():e()},500)})).then(function(){chrome.runtime.sendMessage({from:"content_script"},
function(c){screenshot=c.screenshot;c=new Date;c=c.getFullYear()+"-"+("0"+(c.getMonth()+1)).slice(-2).toString()+"-"+("0"+c.getDate()).slice(-2);var e=document.createElement("a");e.download="Screenshot_"+c+"_PageMarker.png";e.href=screenshot;document.body.appendChild(e);e.click();document.body.removeChild(e);c=URL.createObjectURL(new Blob(['<h1 style="font-family:\'Helvetica\',\'Arial\',sans-serif;">Page Marker Screenshot</h1><img width="100%" src="'+screenshot+'"></img>'],{type:"text/html"}));window.open(c);
a.style.display="block"})}).catch(function(){console.error("An error has occured.")})}function S(){b.clear();A()}function T(){d(ha);J=!0;b.freeDrawingBrush=ia;f.value=U;b.freeDrawingBrush.width=parseInt(f.value)||5}function V(){d(ja);z=!0;b.freeDrawingBrush=B;b.freeDrawingBrush.color=convertHex(l.value);f.value=W;b.freeDrawingBrush.width=parseInt(f.value)||5}function X(){d(Y);b.freeDrawingBrush=B;b.freeDrawingBrush.color=l.value;f.value=C;b.freeDrawingBrush.width=parseInt(f.value)||5}function Z(){d(ka);
K=!0;b.isDrawingMode=!1;b.wrapperEl.style.pointerEvents="none"}function L(){d(la);b.isDrawingMode=!1;I=!0;b.getObjects().forEach(a=>{a.selectable=!0;a.hoverCursor="move"})}function aa(){d(ma);n=!0;b.isDrawingMode=!1;f.value=na}function q(){d(oa);p=!0;f.value=C;b.isDrawingMode=!1;b.selection=!1;ba()}function ba(){b.getObjects().forEach(a=>{a.selectable=!1;a.hoverCursor="normal"})}function r(a,c){c?(a.style.opacity=1,a.style.cursor="pointer"):(a.style.opacity=.3,a.style.cursor="not-allowed")}function A(){M=
[];r(D,!1);null!==t&&(N.push(t),r(E,!0));t=JSON.stringify(b)}function ca(a,c,e,h){0!=a.length&&(c.push(t),t=a.pop(),b.clear(),b.loadFromJSON(t),b.renderAll(),r(e,!0),r(h,0<a.length))}function da(){ca(N,M,D,E)}function ea(){ca(M,N,E,D);p&&ba()}var F=document.body,u=document.documentElement,v=document.body.scrollTop||document.documentElement.scrollTop,w=Math.max(F.scrollHeight,F.offsetHeight,u.clientHeight,u.scrollHeight,u.offsetHeight),x=7500;v+screen.height>x&&(x+=(v+screen.height)/7500*7500);x>w&&
(x=w);25E3<x&&(alert("Page Marker does not support pages with this height. Please try again on a different website."),exit());var b=this.__canvas=new fabric.Canvas("c",{isDrawingMode:!0});fabric.Object.prototype.transparentCorners=!0;b.setDimensions({width:document.body.clientWidth,height:x});b.wrapperEl.id="pageMarker_canvas";document.body.appendChild(b.wrapperEl);var k=document.createElement("div");k.id="pageMarker_draggable";document.body.appendChild(k);k.innerHTML='<div id="pageMarker_color"><div class="pageMarker_title">Color</div><input id="pageMarker_colorSelect" type="color" value="#FF0000"></div><div id="pageMarker_tools"><div class="pageMarker_title pageMarker_toolsTitle">Tools</div><div class="pageMarker_toolDiv"><a id="pageMarker_pen" class="pageMarker_tool"><img id="pageMarker_penImg" class="pageMarker_icon" alt="Marker" title="Marker"></img></a><a id="pageMarker_highlighter" class="pageMarker_tool"><img id="pageMarker_highlighterImg" class="pageMarker_icon" alt="Highlighter" title="Highlighter"></img></a><a id="pageMarker_eraser" class="pageMarker_tool"><img id="pageMarker_eraserImg" class="pageMarker_icon" alt="Eraser" title="Eraser"></img></a><a id="pageMarker_pointer" class="pageMarker_tool"><img id="pageMarker_pointerImg" class="pageMarker_icon" alt="Pointer" title="Pointer"></img></a><a id="pageMarker_text" class="pageMarker_tool"><img id="pageMarker_textImg" class="pageMarker_icon" alt="Text" title="Text"></img></a><a id="pageMarker_move" class="pageMarker_tool"><img id="pageMarker_moveImg" class="pageMarker_icon" alt="Move" title="Move"></img></a><a id="pageMarker_line" class="pageMarker_tool"><img id="pageMarker_lineImg" class="pageMarker_icon" alt="Line" title="Line"></img></a><a id="pageMarker_save" class="pageMarker_tool"><img id="pageMarker_saveImg" class="pageMarker_icon" alt="Save" title="Save Drawing"></img></a><a id="pageMarker_undo" class="pageMarker_tool"><img id="pageMarker_undoImg" class="pageMarker_icon" alt="Undo" title="Undo"></img></a><a id="pageMarker_redo" class="pageMarker_tool"><img id="pageMarker_redoImg" class="pageMarker_icon" alt="Redo" title="Redo"></img></a><a id="pageMarker_clear" class="pageMarker_tool"><img id="pageMarker_clearImg" class="pageMarker_icon" alt="Clear" title="Clear"></img></a><a id="pageMarker_exit" class="pageMarker_tool"><img id="pageMarker_exitImg" class="pageMarker_icon" alt="Exit" title="Exit"></img></a></div></div><div id="pageMarker_size"><div class="pageMarker_title">Size</div><input type="range" id="pageMarker_thicknessSlider" value="5" max="60" min="1"></div>';
k.style.top=v+"px";0==Math.floor(2*Math.random())&&(w=document.createElement("div"),w.id="pageMarker_donateContainer",w.innerHTML='<a title="Donate" id="pageMarker_donate" class="pageMarker_kofi-button" href="https://pagemarker.org/donate" target="_blank"><span class="pageMarker_kofitext"><img id="pageMarker_donateImg" alt="Donate" class="pageMarker_kofiimg">Donate</span></a>',k.appendChild(w),document.getElementById("pageMarker_donateImg").src=chrome.runtime.getURL("cup-border.png"));k.addEventListener("mousedown",
function(a){function c(fa){k.style.top=fa.clientY-pa+"px";k.style.left=fa.clientX-h+"px"}function e(){window.removeEventListener("mousemove",c);window.removeEventListener("mouseup",e);window.removeEventListener("contextmenu",e)}var h=a.clientX-parseInt(window.getComputedStyle(this).left),pa=a.clientY-parseInt(window.getComputedStyle(this).top);window.addEventListener("mousemove",c);f.addEventListener("mousemove",e);window.addEventListener("mouseup",e);window.addEventListener("contextmenu",e)});var R=
document.querySelectorAll(".pageMarker_tool");R.forEach(function(a,c){let e=[X,V,T,Z,aa,L,q,H,da,ea,S,exit];var h=a.querySelector("img");h.src=chrome.runtime.getURL(h.alt.toLowerCase()+".png");a.onclick=e[c]});var l=document.getElementById("pageMarker_colorSelect"),Y=document.getElementById("pageMarker_pen"),ka=document.getElementById("pageMarker_pointer"),la=document.getElementById("pageMarker_move"),ma=document.getElementById("pageMarker_text"),oa=document.getElementById("pageMarker_line"),ha=document.getElementById("pageMarker_eraser"),
ja=document.getElementById("pageMarker_highlighter"),f=document.getElementById("pageMarker_thicknessSlider"),C=g.penThickness,W=g.highlightThickness,U=g.eraseThickness,na=g.textSize;Y.style.background="rgba(0,0,0,0.2)";f.value=C;l.value=g.penColor;var ia=new fabric.EraserBrush(b),B=b.freeDrawingBrush;B.color=l.value;B.width=parseInt(f.value)||5;f.addEventListener("input",function(){J?U=f.value:z?W=f.value:C=f.value;b.freeDrawingBrush.width=parseInt(f.value)||5},!1);l.addEventListener("input",function(){var a=
this.value;z&&(a=convertHex(a));b.freeDrawingBrush.color=a;document.getElementById("pageMarker_donate")&&(document.getElementById("pageMarker_donate").style.backgroundColor=this.value)},!1);var y=!1,z=!1,J=!1,K=!1,n=!1,p=!1,I=!1,O=!1;b.getContext("2d");b.on("text:editing:entered",function(a){y=!0});b.on("text:editing:exited",function(a){y=n=!1;L()});var P=!1;b.on("mouse:down",function(a){P=!0;if(n&&!y){var c=a.e;a=2*parseInt(f.value);if("touchstart"==c.type){var e=c.target.getBoundingClientRect();
var h=c.targetTouches[0].pageX-e.left;c=c.targetTouches[0].pageY-e.top}else h=c.offsetX,c=c.offsetY;a=new fabric.IText("",{fontFamily:"arial",fontSize:a,fill:l.value,left:h,top:c-a/2});b.add(a).setActiveObject(a);a.enterEditing()}else p&&(O=!0,a=b.getPointer(a.e),q=new fabric.Line([a.x,a.y,a.x,a.y],{strokeWidth:parseInt(f.value),fill:l.value,stroke:l.value,originX:"center",originY:"center",selectable:!1,hoverCursor:"normal",targetFindTolerance:!0}),b.add(q))});b.on("mouse:move",function(a){p&&O&&
(a=b.getPointer(a.e),q.set({x2:a.x,y2:a.y}),b.renderAll())});b.on("object:modified",function(a){A()});b.on("mouse:up",function(a){P=!1;I||n||(A(),p&&(O=!1,q.setCoords()))});window.onscroll=function(){v=document.body.scrollTop||document.documentElement.scrollTop;if(v+screen.height>b.getHeight()){var a=b,c=Math.max(F.scrollHeight,F.offsetHeight,u.clientHeight,u.scrollHeight,u.offsetHeight);c=a.getHeight()+7500<c?a.getHeight()+7500:c;c!=a.getHeight()&&a.setHeight(c)}k.style.top=v+"px";25E3<b.getHeight()&&
(alert("Page Marker does not support pages with this height. Please try again on a different website."),exit())};var E=document.getElementById("pageMarker_undo"),D=document.getElementById("pageMarker_redo");r(E,!1);r(D,!1);var t,N=[],M=[],Q={};document.addEventListener("keydown",function(a){Q[a.code]=!0;if("Backspace"==a.code&&!n&&!y){for(let c=0;c<b.getActiveObjects().length;c++)b.remove(b.getActiveObjects()[c]);b.discardActiveObject().renderAll();A()}"Escape"==a.code&&exit();m={KeyZ:da,KeyR:ea,
KeyD:X,KeyH:V,KeyM:L,KeyT:aa,KeyP:Z,KeyL:q,KeyE:T,KeyX:S};if(!y&&!n&&!P&&Q.ShiftLeft&&m[a.code]&&("KeyX"==a.code&&!K||"KeyX"!=a.code))m[a.code]()});document.addEventListener("keyup",function(a){Q[a.code]=!1})};
